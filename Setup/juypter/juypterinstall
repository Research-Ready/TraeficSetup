#!/bin/bash
set -e

if [ "$(id -u)" -ne 0 ]; then
  echo "Run as root (sudo)." >&2
  exit 1
fi

echo "ğŸŸ¢ Updating APT"
apt-get update

echo "ğŸ› ï¸ Installing base packages (Python, venv, Node.js, npm)"
apt-get install -y python3 python3-pip python3-venv curl nodejs npm sudo

echo "ğŸŸ¢ Creating Python virtual environment at /opt/jupyterhub-venv"
python3 -m venv /opt/jupyterhub-venv

echo "âœ… Activating virtual environment and installing pip packages"
source /opt/jupyterhub-venv/bin/activate

pip install --upgrade pip wheel
pip install jupyterhub jupyterhub-traefik-proxy notebook

echo "ğŸŸ¢ Installing configurable-http-proxy globally"
npm install -g configurable-http-proxy

deactivate

echo "ğŸ“ Creating JupyterHub config directory"
mkdir -p /srv/jupyterhub

echo "ğŸ“ Writing example jupyterhub_config.py"
cat <<EOF >/srv/jupyterhub/jupyterhub_config.py
c = get_config()
c.JupyterHub.bind_url = 'http://0.0.0.0:8000'
c.JupyterHub.authenticator_class = 'dummy'
c.DummyAuthenticator.password = "yourpassword"
EOF

echo "âš¡ Performing test run to verify JupyterHub binary"
source /opt/jupyterhub-venv/bin/activate

if /opt/jupyterhub-venv/bin/jupyterhub --help >/dev/null 2>&1; then
  echo "âœ… JupyterHub command is working"
else
  echo "âŒ JupyterHub command not found or failed"
  exit 1
fi

deactivate

echo ""
echo "âœ… âœ… All done!"
echo ""
echo "âœ¨ To start JupyterHub now, run:"
echo "source /opt/jupyterhub-venv/bin/activate"
echo "jupyterhub -f /srv/jupyterhub/jupyterhub_config.py"
echo ""
echo "ğŸ’¡ Then access it at: http://10.0.6.14:8000 or via Traefik on your public domain."
echo "âš ï¸ Don't forget: this config uses DummyAuthenticator, which is insecure for production!"
echo ""