#!/bin/bash
set -e

# Usage info
if [ "$#" -lt 2 ]; then
  echo "Usage: $0 <container_ip> <public_url>"
  echo "Example: $0 10.0.6.14 https://jupyter.valuechainhackers.xyz"
  exit 1
fi

CONTAINER_IP="$1"
PUBLIC_URL="$2"

echo "ğŸ” Checking JupyterHub internal setup..."

# Check venv
if [ ! -d "/opt/jupyterhub-venv" ]; then
  echo "âŒ Virtual environment /opt/jupyterhub-venv not found!"
  echo "ğŸ’¡ Suggestion: Did you run the setup script to create it? Run:"
  echo "    python3 -m venv /opt/jupyterhub-venv"
  exit 1
fi
echo "âœ… Virtual environment found."

# Check JupyterHub binary
if [ ! -f "/opt/jupyterhub-venv/bin/jupyterhub" ]; then
  echo "âŒ JupyterHub binary not found in venv!"
  echo "ğŸ’¡ Suggestion: Activate venv and reinstall:"
  echo "    source /opt/jupyterhub-venv/bin/activate"
  echo "    pip install jupyterhub"
  exit 1
fi
echo "âœ… JupyterHub binary found."

# Check config file
if [ ! -f "/srv/jupyterhub/jupyterhub_config.py" ]; then
  echo "âŒ Config file /srv/jupyterhub/jupyterhub_config.py not found!"
  echo "ğŸ’¡ Suggestion: Check if you created it correctly or rerun your config generation script."
  exit 1
fi
echo "âœ… Config file found."

# Check configurable-http-proxy
if ! command -v configurable-http-proxy >/dev/null 2>&1; then
  echo "âŒ configurable-http-proxy not found!"
  echo "ğŸ’¡ Suggestion: Install it globally with:"
  echo "    npm install -g configurable-http-proxy"
else
  echo "âœ… configurable-http-proxy found."
fi

# Check Python version
source /opt/jupyterhub-venv/bin/activate
PY_VER=$(python --version)
echo "âœ… Python version in venv: $PY_VER"

# Check pip packages
echo "ğŸ“¦ Checking if JupyterHub and notebook are installed..."
if ! pip show jupyterhub >/dev/null 2>&1 || ! pip show notebook >/dev/null 2>&1; then
  echo "âŒ JupyterHub or notebook package not found!"
  echo "ğŸ’¡ Suggestion: Install missing packages inside venv:"
  echo "    pip install jupyterhub notebook"
  deactivate
  exit 1
else
  echo "âœ… JupyterHub and notebook packages installed."
fi
deactivate

# Check port 8000
if ss -tulpn | grep ":8000 " >/dev/null 2>&1; then
  echo "âš ï¸ Port 8000 is in use. JupyterHub might be running."
  echo "ğŸ’¡ Suggestion: Check running processes with:"
  echo "    ss -tulpn | grep 8000"
else
  echo "âœ… Port 8000 is free."
fi

# Localhost check
echo "ğŸ”— Testing JupyterHub on localhost:8000..."
if curl -s -I "http://127.0.0.1:8000" | grep -q "200 OK"; then
  echo "âœ… JupyterHub is responding on localhost:8000"
else
  echo "âŒ No response from localhost:8000."
  echo "ğŸ’¡ Suggestion: Make sure JupyterHub is running:"
  echo "    source /opt/jupyterhub-venv/bin/activate"
  echo "    jupyterhub -f /srv/jupyterhub/jupyterhub_config.py"
fi

# Container IP check
echo "ğŸŒ Testing JupyterHub on container IP ($CONTAINER_IP:8000)..."
if curl -s -I "http://$CONTAINER_IP:8000" | grep -q "200 OK"; then
  echo "âœ… JupyterHub is responding on $CONTAINER_IP:8000"
else
  echo "âŒ No response from $CONTAINER_IP:8000."
  echo "ğŸ’¡ Suggestion: Check network bridge configuration and firewall rules."
fi

# Public URL check
echo "ğŸŒ Testing JupyterHub on public URL ($PUBLIC_URL)..."
if curl -s -I "$PUBLIC_URL" | grep -q "200 OK"; then
  echo "âœ… Public URL is responding correctly!"
else
  echo "âŒ No response from public URL."
  echo "ğŸ’¡ Suggestions:"
  echo "  - Check your Traefik dynamic config file and ensure correct IP mapping."
  echo "  - Check DNS records for $PUBLIC_URL point to Traefik public IP."
  echo "  - Check firewall rules on the server and Traefik container logs."
fi

echo "ğŸ‰ All checks completed!"